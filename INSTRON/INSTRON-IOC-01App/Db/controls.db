record(bo, "$(P)SIM")
{
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
    field(ZNAM, "NO")
    field(ONAM, "YES")
    field(VAL, "$(RECSIM=0)")
    field(PINI, "YES")
}
    
record(bo, "$(P)DISABLE") 
{
    field(DESC, "Disable comms")
    field(PINI, "YES")
    field(VAL, "$(DISABLE=0)")
    field(OMSL, "supervisory")
    field(ZNAM, "COMMS ENABLED")
    field(ONAM, "COMMS DISABLED")
}

record(mbbi, "$(P)CHANNEL")
{
    field(DESC, "Current control channel")
    field(DTYP, "stream")
    field(INP,  "@devInstron.proto getCurrentControlChannel $(PORT)")
    field(SCAN, "1 second")
    
    field(ZRVL, 1)
    field(ZRST, "Position")    
    field(ONVL, 2)
    field(ONST, "Stress")       
    field(TWVL, 3)
    field(TWST, "Strain")
    
    field(SIML, "$(P)SIM")
    field(SDIS, "$(P)DISABLE")
}

record(mbbo, "$(P)CHANNEL:SP")
{
    field(DESC, "Control channel setpoint")
    field(DTYP, "stream")
    
    field(ZRVL, 1)
    field(ZRST, "Position")    
    field(ONVL, 2)
    field(ONST, "Stress")       
    field(TWVL, 3)
    field(TWST, "Strain")
    
    field(OUT,  "@devInstron.proto setCurrentControlChannel $(PORT)")
    field(SIML, "$(P)SIM")
    field(SDIS, "$(P)DISABLE")
}

record(bi, "$(P)WATCHDOG:STATUS")
{
    field(DESC, "Watchdog on/off")
    field(DTYP, "stream")
    field(INP,  "@devInstron.proto getWatchdogStatus $(PORT)")
    field(SCAN, "1 second")
    field(SIML, "$(P)SIM")
    field(ZNAM, "DISABLED")
    field(ONAM, "ENABLED")
    field(SDIS, "$(P)DISABLE")
}
    
record(bo, "$(P)WATCHDOG:STATUS:SP")
{
    field(DESC, "Watchdog on/off setpoint")
    field(DTYP, "stream")
    field(OUT,  "@devInstron.proto setWatchdogStatus $(PORT)")
    field(ZNAM, "DISABLED")
    field(ONAM, "ENABLED")
    field(SIML, "$(P)SIM")
    field(SDIS, "$(P)DISABLE")  
}

record(bi, "$(P)CONTROLMODE")
{
    field(DESC, "Control mode")
    field(DTYP, "stream")
    field(INP,  "@devInstron.proto getControlMode $(PORT)")
    field(SCAN, "1 second")
    field(SIML, "$(P)SIM")
    field(ZNAM, "FRONTPANEL")
    field(ONAM, "COMPUTER")
    field(SDIS, "$(P)DISABLE")
}
    
record(bo, "$(P)CONTROLMODE:SP")
{
    field(DESC, "Watchdog on/off setpoint")
    field(DTYP, "stream")
    field(OUT,  "@devInstron.proto setControlMode $(PORT)")
    field(ZNAM, "FRONTPANEL")
    field(ONAM, "COMPUTER")
    field(SIML, "$(P)SIM")
    field(SDIS, "$(P)DISABLE")  
}

record(seq, "$(P)INIT")
{
    field(DESC, "Initialize comms")
    
    # Set control mode to COMPUTER
    field(DO1, "1")
    field(LNK1, "$(P)CONTROLMODE:SP PP")
    
    # Disable Watchdog
    field(DO2, "0")
    field(LNK2, "$(P)WATCHDOG:STATUS:SP PP")
    
    field(SELM, "All")
    field(PINI, "TRUE")
}

record(mbbiDirect, "$(P)STATUS:FRAME")
{
    field(DESC, "Status bits")
    field(DTYP, "stream")
    field(INP, "@devInstron.proto getStatus $(PORT)")
    field(SCAN, "1 second")
    field(ZRVL, "0")
    field(ONVL, "1")
    field(FLNK, "$(P)STATUS:_FANOUT")
}

record(fanout, "$(P)STATUS:_FANOUT")
{
    field(LNK1, "$(P)STATUS:_CALC")
    field(LNK2, "$(P)ACTUATOR:STATUS")
    field(SELM, "All")
}

record(mbbi, "$(P)STATUS:DISP")
{
    field(DESC, "Display string for rig status")
    field(INP, "$(P)STATUS:_CALC")

    field(SXVL, "6")
    field(SVVL, "7")
    field(EIVL, "8")
    field(NIVL, "9")
    field(TEVL, "10")
    field(ELVL, "11")
    field(TVVL, "12")
    field(TTVL, "13")
    field(FTVL, "14")
    field(FFVL, "15")

    field(SXST, "Emergency stop pushed")
    field(SVST, "Oil too hot")
    field(EIST, "Oil level too low")
    field(NIST, "Motor too hot")
    field(TEST, "Oil pressure too high")
    field(ELST, "Oil pressure too low")     
    field(TVST, "Manifold or pump filter blocked")
    field(TTST, "Oil level going too low")
    field(FTST, "Manifold low pressure switch")
    field(FFST, "System OK")
}

record(calc, "$(P)STATUS:_CALC")
{
    field(DESC, "Calculation for finding display string")
    
    field(INPA, "$(P)STATUS:FRAME.B9 CP")
    field(INPB, "$(P)STATUS:FRAME.BA CP")
    field(INPC, "$(P)STATUS:FRAME.BB CP")
    field(INPD, "$(P)STATUS:FRAME.BC CP")
    
    field(CALC, "A+(2*B)+(4*C)+(8*D)") 
    field(FLNK, "$(P)STATUS:DISP")
}

record(calc, "$(P)ACTUATOR:STATUS")
{
    field(INPA, "$(P)STATUS:FRAME.B3 CP")
    field(CALC, "A=0?1:0")
    field(ZNAM, "OFF")
    field(ONAM, "ON")
}

record(stringout, "$(P)ARBITRARY:SP")
{
	field(DESC, "General write command")
	field(FLNK, "$(P)ARBITRARY")
    field(SDIS, "$(P)DISABLE")
    info(archive, "VAL")
    info(INTEREST, "HIGH")
}

record(stringin, "$(P)ARBITRARY")
{
    field(DESC, "General input command response")
    field(DTYP, "stream")
    field(INP, "@devInstron.proto arbRW($(P)ARBITRARY:SP) $(PORT)")
    field(SCAN, "Passive")
    field(SDIS, "$(P)DISABLE")
    info(archive, "VAL")
    info(INTEREST, "HIGH")
}

record(bi, "$(P)PANIC")
{
	field(DESC, "Panic stop")
    field(DTYP, "stream")
    field(INP,  "@devInstron.proto getActuatorStatus $(PORT)")
    field(SCAN, "1 second")
    field(ZNAM, "STOPPED")
    field(ONAM, "PANIC STOP")
}

record(bo, "$(P)PANIC:RAW")
{
	field(DESC, "Panic stop")
    field(DTYP, "stream")
    field(OUT,  "@devInstron.proto setActuatorStatus $(PORT)")
    field(ZNAM, "STOPPED")
    field(ONAM, "PANIC STOP")
}

record(bo, "$(P)PANIC:SP"){
    field(ZNAM, "STOPPED")
    field(ONAM, "PANIC STOP")
    field(FLNK, "$(P)PANIC:_SEQ")
}

record(seq, "$(P)PANIC:_SEQ")
{
	field(DESC, "Panic stop sequence")
    
    # Set control mode to COMPUTER
    field(DO1, "1")
    field(LNK1, "$(P)CONTROLMODE:SP PP")
    
    field(DOL2, "$(P)PANIC:SP")
    field(LNK2, "$(P)PANIC:RAW PP")
    
    # Set control mode to LOCAL
    field(DO3, "0")
    field(LNK3, "$(P)CONTROLMODE:SP PP")
    
    field(SELM, "All")
}
