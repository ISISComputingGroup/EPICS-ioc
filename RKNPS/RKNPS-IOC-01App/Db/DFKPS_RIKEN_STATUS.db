record(bi, "$(P)POWER")
{
    field(DESC, "Power")
    field(ZNAM, "Off")
    field(ONAM, "On")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
	field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:POWER")
    field(SDIS, "$(P)DISABLE")
}

record(calcout, "$(P)POWER:_CALC")
{
    field(INPA, "$(P)STA1.BF CP MS")
	field(CALC, "!A")
}

alias("$(P)POWER", "$(P)POWER:RBV")

record(longin, "$(P)STATUS")
{
    field(DESC, "Device Status Flags")
    field(DTYP, "stream")
    field(INP,  "@dfkps_riken.proto status($(ADR)) $(port) 0")
    field(SCAN, "5 second")
    field(FLNK, "$(P)CALPOWER")
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:STATUS")
    field(SDIS, "$(P)DISABLE")
}

record(scalcout, "$(P)CALPOWER")
{
    field(DESC, "Update Power Status")
    field(OUT,  "$(P)POWER PP MS")
    field(CALC, "BB==AA[$(powpos),$(powpos)] ? CC : DD")
    field(INAA, "$(P)STATUS MS")
    field(BB, "!")
    field(CC, "Off")
    field(DD, "On")
    field(FLNK, "$(P)CALILK")
}

record(scalcout, "$(P)CALILK")
{
    field(DESC, "Update Interlock Status")
    field(OUT,  "$(P)ILK PP MS")
    field(CALC, "BB==AA[$(ilkpos),$(ilkpos)] ? CC : DD")
    field(INAA, "$(P)STATUS MS")
    field(BB, "!")
    field(CC, "Tripped")
    field(DD, "OK")
}

record(stringin, "$(P)SIM:STATUS"){
    field(DTYP, "Soft Channel")
}

record(calcout, "$(P)CALSTA1")
{
    field(DESC, "Get Status Flags 1-16")
    field(CALC, "(A>>8)&65535")
    field(INPA, "$(P)STATUS CP MS")
}

record(calcout, "$(P)CALSTA2")
{
    field(DESC, "Get Status Flags 16-24")
    field(CALC, "(A<<8)&65535")
    field(INPA, "$(P)STATUS CP MS")
}

record(mbbiDirect, "$(P)STA1")
{
    field(DESC, "Status Flags 1-16")
	field(INP, "$(P)CALSTA1 CP MS")
	field(DTYP, "Raw Soft Channel")
    # 0 = Main power off
    # 1 = Polarity normal
    # 2 = Polarity reversed
    # 3 = Regulation transformer <> 0 * Main power
    # 4 = !
    # 5 = !
    # 6 = High = %, low = amps/volts
    # 7 = Spare interlock
    # 8 = One transistor fault
    # 9 = Sum interlocks
    # A = DC Overcurrent
    # B = DC Overload
    # C = Regulation module failure
    # D = Preregulator failure
    # E = Phase failure
    # F = MPS water flow failure
}

record(mbbiDirect, "$(P)STA2")
{
    field(DESC, "Status Flags 16-24")
	field(INP, "$(P)CALSTA2 CP MS")
	field(DTYP, "Raw Soft Channel")
    # 8 = Earth leakage failure
    # 9 = Thermal breaker / fuses
    # A = MPS over temperature
    # B = Panic button / door switch
    # C = Magnet water flow failure
    # D = Magnet over temperature
    # E = MPS not ready
    # F = .
}

record(bi, "$(P)ILK:TRANS")
{
    field(INP, "$(P)STA1.B7 CP MS")
    field(DESC, "Transistor fault interlock")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}

record(bi, "$(P)ILK:DCOC")
{
    field(INP, "$(P)STA1.B5 CP MS")
    field(DESC, "DC overcurrent interlock")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}

record(bi, "$(P)ILK:POWER")
{
    field(INP, "$(P)STA1.B0 CP MS")
    field(DESC, "Main power off")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}

record(bi, "$(P)ILK:POLNORM")
{
    field(INP, "$(P)STA1.B1 CP MS")
    field(DESC, "Polarity normal")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}

record(bi, "$(P)ILK:POLREV")
{
    field(INP, "$(P)STA1.B2 CP MS")
    field(DESC, "Polarity reversed")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}

record(bi, "$(P)ILK:REGTRANSF")
{
    field(INP, "$(P)STA1.B3 CP MS")
    field(DESC, "Reg transformer * pwr")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}

record(bi, "$(P)ILK:PERCENT")
{
    field(INP, "$(P)STA1.B6 CP MS")
    field(DESC, "Percent or decimal mode")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}

record(bi, "$(P)ILK:TRANS")
{
    field(INP, "$(P)STA1.B8 CP MS")
    field(DESC, "Transistor fault interlock")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}

record(bi, "$(P)ILK")
{
    field(INP, "$(P)STA1.B9 CP MS")
    field(DESC, "Overall Interlock")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}

record(bi, "$(P)ILK:DCOC")
{
    field(INP, "$(P)STA1.BA CP MS")
    field(DESC, "DC overcurrent interlock")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}

record(bi, "$(P)ILK:DCOLOAD")
{
    field(INP, "$(P)STA1.BB CP MS")
    field(DESC, "DC overload interlock")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}

record(bi, "$(P)ILK:REGMOD")
{
    field(INP, "$(P)STA1.BC CP MS")
    field(DESC, "DC overload interlock")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}

record(bi, "$(P)ILK:PREREG")
{
    field(INP, "$(P)STA1.BD CP MS")
    field(DESC, "Preregulator interlock")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}

record(bi, "$(P)ILK:PHAS")
{
    field(INP, "$(P)STA1.BE CP MS")
    field(DESC, "Phase failure interlock")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}

record(bi, "$(P)ILK:MPSWATER")
{
    field(INP, "$(P)STA1.BF CP MS")
    field(DESC, "MPS water flow interlock")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}

record(bi, "$(P)ILK:EARTHLEAK")
{
    field(INP, "$(P)STA2.B8 CP MS")
    field(DESC, "Earth leak interlock")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}

record(bi, "$(P)ILK:THERMAL")
{
    field(INP, "$(P)STA2.B9 CP MS")
    field(DESC, "Thermal breaker interlock")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}

record(bi, "$(P)ILK:MPSTEMP")
{
    field(INP, "$(P)STA2.BA CP MS")
    field(DESC, "")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}

record(bi, "$(P)ILK:DOOR")
{
    field(INP, "$(P)STA1.BB CP MS")
    field(DESC, "Panic button/door")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}

record(bi, "$(P)ILK:MAGWATER")
{
    field(INP, "$(P)STA1.BC CP MS")
    field(DESC, "Magnet water interlock")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}

record(bi, "$(P)ILK:MAGTEMP")
{
    field(INP, "$(P)STA1.BD CP MS")
    field(DESC, "Magnet overtemp interlock")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}

record(bi, "$(P)ILK:MPSREADY")
{
    field(INP, "$(P)STA1.BE CP MS")
    field(DESC, "MPS not ready")
    field(ZNAM, "OK")
    field(ONAM, "Tripped")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}
