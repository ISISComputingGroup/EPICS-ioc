# MACROS
#
# P - PV Prefix
# CALIB_FILE - calibration file name
# CALIB_DIR - file for magnets within calibartion 
# CALIB_BASE_DIR - path for calibration base directory


record(calcout, "$(P)FIELD:PRECALIB"){
    field(INPA, "$(P)CURR")
    field(CALC, "A*1000000")
	field(FLNK, "$(P)FIELD:CALIB")
    field(EGU, "")
}

record(cvt, "$(P)FIELD:CALIB"){
    field(INPX, "$(P)FIELD:PRECALIB")
    field(Y, 1)
    field(METH, "1D TABLE")
    field(DRVL, "$(DRVLO)")
    field(DRVH, "$(DRVHI)")
    field(SPEC, "$(CALIB_FILE)")
	field(TDIR, "$(CALIB_DIR)")
    field(BDIR, "$(CALIB_BASE_DIR)")
    field(FLNK, "$(P)FIELD:TOUNIT")
    field(EGU, "")
}

record(calc, "$(P)FIELD:TOUNIT"){
    field(INPA, "$(P)FIELD:UNIT PP")
    field(INPB, "$(P)FIELD:CALIB PP")
    field(CALC, "A==2?B/10000:B")
    field(FLNK, "$(P)FIELD")
    field(EGU, "")
}

record(ai, "$(P)FIELD"){
    field(DESC, "Field")
    field(INP, "$(P)FIELD:TOUNIT PP MS")
    field(EGU, "")
    field(PREC, "3")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
}
alias("$(P)FIELD", "$(P)FIELD:RBV")

record(ao, "$(P)FIELD:SP") {
    field(FLNK, "$(P)FIELD:SP:FROMUNIT")
    field(EGU, "")
    field(PREC, "3")
}
alias("$(P)FIELD:SP", "$(P)FIELD:SP:RBV")

record(calc, "$(P)FIELD:SP:FROMUNIT"){
    field(INPA, "$(P)FIELD:UNIT PP")
    field(INPB, "$(P)FIELD:SP PP")
    field(CALC, "A==2?B*10000:B")
    field(FLNK, "$(P)FIELD:SP:CALIB")
    field(EGU, "Oersted")
}

record(cvt, "$(P)FIELD:SP:CALIB"){
    field(INPY, "$(P)FIELD:SP:FROMUNIT")
    field(X, 1)
    field(METH, "1D TABLE INVERTED")
    field(DRVL, "$(DRVLO)")
    field(DRVH, "$(DRVHI)")
    field(SPEC, "$(CALIB_FILE)")
	field(TDIR, "$(CALIB_DIR)")
    field(BDIR, "$(CALIB_BASE_DIR)")
	field(NSPE, "$(P)CFILE")
	field(NTDI, "$(P)CPATH")
    field(OUT, "$(P)FIELD:SP:PRECALIB.A")
    field(FLNK, "$(P)FIELD:SP:PRECALIB")
    field(EGU, "")
}

record(calcout, "$(P)FIELD:SP:PRECALIB"){
    field(CALC, "A/1000000")
    field(OUT, "$(P)RAW:SP PP MS")
    field(EGU, "")
}

record(mbbi, "$(P)FIELD:UNIT"){
    field(DESC, "Field Unit to Display")
    field(ZRVL, 0)
    field(ONVL, 1)
    field(TWVL, 2)
    field(ZRST, "Oersted")
    field(ONST, "Gauss")
    field(TWST, "Tesla")
    field(FLNK, "$(P)FIELD:TOUNIT")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
    info(autosaveFields, "VAL")
}
alias("$(P)FIELD:UNIT", "$(P)FIELD:UNIT:RBV")
alias("$(P)FIELD:UNIT", "$(P)FIELD:UNIT:SP")
alias("$(P)FIELD:UNIT:SP", "$(P)FIELD:UNIT:SP:RBV")

record(stringin, "$(P)CFILE"){
	field(DESC, "Calibration File Name")
	field(VAL, "$(CALIB_FILE)")
}

record(stringout, "$(P)CFILE:UPD1"){
	field(DOL, "$(P)CFILE CP")
    field(OMSL, "closed_loop")
	field(OUT, "$(P)FIELD:CALIB.NSPE PP")
	field(FLNK, "$(P)CINIT1")
}

record(stringout, "$(P)CFILE:UPD2"){
	field(DOL, "$(P)CFILE CP")
    field(OMSL, "closed_loop")
	field(OUT, "$(P)FIELD:SP:CALIB.NSPE PP")
	field(FLNK, "$(P)CINIT2")
}

record(stringin, "$(P)CPATH"){
	field(DESC, "Calibration File Path wrt path.")
	field(VAL, "$(CALIB_DIR)")
}

record(stringin, "$(P)CBASEPATH"){
	field(DESC, "Calibration Base File Path")
	field(VAL, "$(CALIB_BASE_DIR)")
}

record(stringout, "$(P)CPATH:UPD1"){
	field(DOL, "$(P)CPATH CP")
    field(OMSL, "closed_loop")
	field(OUT, "$(P)FIELD:CALIB.NTDI")
	field(FLNK, "$(P)CINIT1")
}

record(stringout, "$(P)CBASEPATH:UPD1"){
	field(DOL, "$(P)CBASEPATH CP")
    field(OMSL, "closed_loop")
	field(OUT, "$(P)FIELD:CALIB.NBDI")
	field(FLNK, "$(P)CINIT1")
}

record(stringout, "$(P)CPATH:UPD2"){
	field(DOL, "$(P)CPATH CP")
    field(OMSL, "closed_loop")
	field(OUT, "$(P)FIELD:SP:CALIB.NTDI")
	field(FLNK, "$(P)CINIT2")
}

record(stringout, "$(P)CBASEPATH:UPD2"){
	field(DOL, "$(P)CBASEPATH CP")
    field(OMSL, "closed_loop")
	field(OUT, "$(P)FIELD:SP:CALIB.NBDI")
	field(FLNK, "$(P)CINIT2")
}

record(bo, "$(P)CINIT1"){
	field(DESC, "Re-initialise Calibration Record")
	field(VAL, 1)
	field(OUT, "$(P)FIELD:CALIB.INIT")
}

record(bo, "$(P)CINIT2"){
	field(DESC, "Re-initialise Calibration Record")
	field(VAL, 1)
	field(OUT, "$(P)FIELD:SP:CALIB.INIT")
	field(FLNK, "$(P)FIELD:TOUNIT")
}
